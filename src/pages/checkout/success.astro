---
import PublicLayout from '@layouts/PublicLayout.astro';
import { stripe } from '@lib/stripe';
import { supabase } from '@lib/supabase';
import type Stripe from 'stripe';

const sessionId = Astro.url.searchParams.get('session_id');

let stripeSession: Stripe.Checkout.Session | null = null;
let customer = null;
let orderSaved = false;
let orderError: string | null = null;

if (sessionId) {
  try {
    // Retrieve the Stripe session with all details
    stripeSession = await stripe.checkout.sessions.retrieve(sessionId, {
      expand: ['line_items', 'customer'],
    });
    
    if (stripeSession.customer && typeof stripeSession.customer !== 'string') {
      customer = stripeSession.customer;
    }

    // Only save if payment was successful
    if (stripeSession.payment_status === 'paid' && stripeSession.metadata?.user_id) {
      const userId = stripeSession.metadata.user_id;
      
      // Check if order already exists (avoid duplicates)
      const { data: existingOrder } = await supabase
        .from('orders')
        .select('id')
        .eq('stripe_session_id', sessionId)
        .single();

      if (!existingOrder) {
        // Parse cart items from metadata
        let cartItems: any[] = [];
        try {
          cartItems = JSON.parse(stripeSession.metadata.cart_items || '[]');
        } catch (e) {
          console.error('Error parsing cart items:', e);
        }

        // Get shipping details safely (Stripe types may not include shipping_details)
        // @ts-ignore - shipping_details exists on the session but TypeScript types are incomplete
        const shippingDetails = stripeSession['shipping_details'] || null;
        const customerDetails = stripeSession.customer_details;

        // Save order to database
        const { error: insertError } = await supabase
          .from('orders')
          .insert({
            user_id: userId,
            stripe_session_id: sessionId,
            stripe_payment_intent_id: typeof stripeSession.payment_intent === 'string' 
              ? stripeSession.payment_intent 
              : null,
            total_price: (stripeSession.amount_total || 0) / 100, // Convert cents to dollars
            status: 'completed',
            shipping_name: shippingDetails?.name || customerDetails?.name || null,
            shipping_address: shippingDetails?.address || null,
            shipping_phone: customerDetails?.phone || null,
            billing_email: stripeSession.customer_email || customerDetails?.email || null,
            items: cartItems,
          });

        if (insertError) {
          console.error('Error saving order:', insertError);
          orderError = insertError.message;
        } else {
          orderSaved = true;
          console.log(`✅ Order saved for user ${userId}`);
        }
      } else {
        // Order already exists
        orderSaved = true;
      }
    }
  } catch (error) {
    console.error('Error retrieving session:', error);
  }
}

const amountTotal = stripeSession?.amount_total ? (stripeSession.amount_total / 100).toFixed(2) : '0.00';
---

<PublicLayout title="¡Pedido Confirmado! | KicksMarket">
  <div class="min-h-screen bg-brand-black flex items-center justify-center px-4">
    <div class="max-w-lg w-full bg-brand-dark p-8 text-center">
      <!-- Success Icon -->
      <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>

      <h1 class="text-3xl font-display font-bold text-white uppercase mb-4">
        ¡Pedido Confirmado!
      </h1>
      
      <p class="text-neutral-400 mb-6">
        Gracias por tu compra. Hemos recibido tu pedido y te enviaremos un correo con los detalles del envío.
      </p>

      {stripeSession && (
        <div class="bg-brand-gray p-6 mb-6 text-left">
          <h2 class="text-brand-red font-bold uppercase text-sm mb-4">Detalles del Pedido</h2>
          
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-neutral-500">Número de pedido:</span>
              <span class="text-white font-mono text-sm">{stripeSession.id.slice(-8).toUpperCase()}</span>
            </div>
            
            <div class="flex justify-between">
              <span class="text-neutral-500">Estado:</span>
              <span class="text-green-500 font-bold">Pagado</span>
            </div>
            
            <div class="flex justify-between">
              <span class="text-neutral-500">Total pagado:</span>
              <span class="text-white font-bold text-lg">${amountTotal} USD</span>
            </div>

            {stripeSession.customer_details?.email && (
              <div class="flex justify-between">
                <span class="text-neutral-500">Email:</span>
                <span class="text-white">{stripeSession.customer_details.email}</span>
              </div>
            )}

            {orderSaved && (
              <div class="flex justify-between items-center pt-2 border-t border-brand-black mt-2">
                <span class="text-neutral-500">Sincronizado:</span>
                <span class="text-green-400 text-sm">✅ Guardado en tu cuenta</span>
              </div>
            )}
          </div>
        </div>
      )}

      {orderError && (
        <div class="bg-red-900/30 border border-red-500 p-4 mb-6 text-left">
          <p class="text-red-400 text-sm">
            ⚠️ Hubo un problema guardando el pedido: {orderError}
          </p>
          <p class="text-neutral-500 text-xs mt-2">
            No te preocupes, tu pago fue procesado. Contacta soporte si no ves tu pedido.
          </p>
        </div>
      )}

      <div class="space-y-3">
        <a 
          href="/pedidos" 
          class="block w-full bg-brand-red text-white py-4 font-bold uppercase tracking-wider hover:bg-brand-orange transition-colors"
        >
          Ver Mis Pedidos
        </a>
        
        <a 
          href="/productos" 
          class="block w-full bg-brand-gray text-white py-4 font-bold uppercase tracking-wider hover:bg-brand-dark transition-colors"
        >
          Seguir Comprando
        </a>
      </div>

      <!-- Clear cart on success -->
      <script>
        // Clear the cart after successful payment
        localStorage.removeItem('fashionmarket-cart');
      </script>
    </div>
  </div>
</PublicLayout>
