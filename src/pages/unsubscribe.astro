---
import PublicLayout from '@layouts/PublicLayout.astro';

const email = Astro.url.searchParams.get('email') || '';
---

<PublicLayout title="Darse de Baja - Newsletter" description="Cancela tu suscripción al newsletter de Kicks Premium">
  <div class="min-h-screen bg-brand-black flex items-center justify-center px-4 py-16">
    <div class="max-w-md w-full">
      <!-- Card -->
      <div class="bg-neutral-900 rounded-2xl p-8 shadow-xl border border-neutral-800">
        <!-- Header -->
        <div class="text-center mb-8">
          <div class="w-16 h-16 bg-neutral-800 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-neutral-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-white mb-2">Darse de Baja</h1>
          <p class="text-neutral-400 text-sm">
            ¿Seguro que quieres dejar de recibir nuestras ofertas exclusivas y nuevos drops?
          </p>
        </div>

        <!-- Form -->
        <form id="unsubscribe-form" class="space-y-6">
          <div>
            <label for="email" class="block text-sm font-medium text-neutral-300 mb-2">
              Email
            </label>
            <input
              type="email"
              id="email"
              name="email"
              value={email}
              required
              placeholder="tu@email.com"
              class="w-full px-4 py-3 bg-neutral-800 border border-neutral-700 rounded-lg text-white placeholder-neutral-500 focus:outline-none focus:ring-2 focus:ring-brand-red focus:border-transparent transition-all"
            />
          </div>

          <button
            type="submit"
            id="unsubscribe-btn"
            class="w-full py-3 px-4 bg-neutral-700 text-white font-semibold rounded-lg hover:bg-neutral-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Cancelar Suscripción
          </button>
        </form>

        <!-- Message -->
        <div id="message" class="mt-4 text-center hidden"></div>

        <!-- Back Link -->
        <div class="mt-6 text-center">
          <a href="/" class="text-sm text-neutral-400 hover:text-white transition-colors">
            ← Volver a la tienda
          </a>
        </div>
      </div>

      <!-- Note -->
      <p class="mt-6 text-center text-xs text-neutral-500">
        Puedes volver a suscribirte en cualquier momento desde nuestra web.
      </p>
    </div>
  </div>
</PublicLayout>

<script is:inline>
  const form = document.getElementById('unsubscribe-form');
  const emailInput = document.getElementById('email');
  const submitBtn = document.getElementById('unsubscribe-btn');
  const messageDiv = document.getElementById('message');

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = emailInput.value.trim();

      if (!email) {
        showMessage('Por favor ingresa tu email', 'error');
        return;
      }

      submitBtn.setAttribute('disabled', 'true');
      submitBtn.textContent = 'Procesando...';

      try {
        const response = await fetch('/api/newsletter/unsubscribe', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email }),
        });

        const data = await response.json();

        if (response.ok) {
          showMessage(
            '✓ ' + (data.message || 'Te has dado de baja correctamente.'),
            'success'
          );
          form.reset();
        } else {
          showMessage(
            data.error || 'Error al procesar la solicitud.',
            'error'
          );
        }
      } catch (error) {
        console.error('Unsubscribe error:', error);
        showMessage('Error de conexión. Intenta más tarde.', 'error');
      } finally {
        submitBtn.removeAttribute('disabled');
        submitBtn.textContent = 'Cancelar Suscripción';
      }
    });
  }

  function showMessage(text, type) {
    if (!messageDiv) return;

    messageDiv.textContent = text;
    messageDiv.className = `mt-4 text-center text-sm ${
      type === 'success'
        ? 'text-green-400'
        : 'text-red-400'
    }`;
    messageDiv.classList.remove('hidden');
  }
</script>
