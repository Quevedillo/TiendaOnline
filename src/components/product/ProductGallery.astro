---
import { getGalleryImageUrl, getThumbnailUrl } from '@lib/cloudinary';

interface ProductGalleryProps {
  images: string[];
  productName: string;
}

const { images, productName } = Astro.props;

// Optimizar URLs de Cloudinary
const optimizeCloudinaryUrl = (url: string, options?: { width?: number; height?: number }): string => {
  // Si no es una URL de Cloudinary, devolver como está
  if (!url.includes('cloudinary.com')) {
    return url;
  }

  // Insertar transformaciones en la URL
  const width = options?.width || 1200;
  const height = options?.height || 1200;
  
  // Formato: https://res.cloudinary.com/CLOUD_NAME/image/upload/[TRANSFORMATIONS]/[PUBLIC_ID]
  const cloudinaryPattern = /(https:\/\/res\.cloudinary\.com\/[^/]+\/[^/]+\/upload\/)(.*)/;
  const match = url.match(cloudinaryPattern);
  
  if (match) {
    const baseUrl = match[1];
    const publicId = match[2];
    // Agregar transformaciones para optimización
    return `${baseUrl}w_${width},h_${height},c_fill,q_auto,f_webp/${publicId}`;
  }
  
  return url;
};

const mainImages = images.slice(0, 1);
const thumbnailImages = images.slice(0, 4);
---

<div class="space-y-4">
  {/* Main Image */}
  <div class="aspect-square bg-neutral-200 overflow-hidden rounded-lg">
    {images.length > 0 ? (
      <picture>
        {/* WebP format for modern browsers */}
        <source
          srcset={optimizeCloudinaryUrl(images[0], { width: 1200, height: 1200 })}
          type="image/webp"
        />
        {/* Fallback for older browsers */}
        <img
          id="main-image"
          src={optimizeCloudinaryUrl(images[0], { width: 1200, height: 1200 })}
          alt={productName}
          class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
          loading="eager"
        />
      </picture>
    ) : (
      <div class="w-full h-full flex items-center justify-center bg-neutral-300">
        <svg class="w-16 h-16 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
      </div>
    )}
  </div>

  {/* Thumbnail Gallery */}
  {thumbnailImages.length > 1 && (
    <div class="grid grid-cols-4 gap-2">
      {thumbnailImages.map((image, index) => (
        <button
          class="thumbnail-btn aspect-square overflow-hidden border-2 border-transparent hover:border-brand-black transition-colors rounded-lg group"
          data-image-url={optimizeCloudinaryUrl(image, { width: 1200, height: 1200 })}
          data-index={index}
        >
          <picture>
            <source
              srcset={optimizeCloudinaryUrl(image, { width: 300, height: 300 })}
              type="image/webp"
            />
            <img
              src={optimizeCloudinaryUrl(image, { width: 300, height: 300 })}
              alt={`${productName} - Imagen ${index + 1}`}
              class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
              loading="lazy"
            />
          </picture>
        </button>
      ))}
    </div>
  )}
</div>

<script>
  // Gallery interaction
  const thumbnails = document.querySelectorAll('.thumbnail-btn');
  const mainImage = document.getElementById('main-image');

  if (mainImage) {
    thumbnails.forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const newUrl = (btn as HTMLElement).dataset.imageUrl;
        
        if (newUrl) {
          // Update main image src
          mainImage.src = newUrl;
          
          // Update active state
          thumbnails.forEach((t) => t.classList.remove('border-brand-black'));
          btn.classList.add('border-brand-black');
        }
      });
    });

    // Set first thumbnail as active
    if (thumbnails.length > 0) {
      thumbnails[0].classList.add('border-brand-black');
    }
  }
</script>

<style>
  img {
    display: block;
  }
</style>
